### MVCC

mysql默认隔离级别（RR Read Repeatable可重复读）

一致性非锁定读，是mysql的INNODB引擎在READ COMMITED和READ REPEATABLE 隔离级别下的默认读取方式。

所谓的非一致性锁定读是指，如果读取的行正在进行执行DELETE或者UPDATE操作，此时的读取操作不会等待行上的锁释放，而是读取改行的快照数据。

#### 基本原理

MVCC的实现，通过保存数据在某个时间点的快照来实现的。这意味着一个事务无论运行多长时间，在同一个事务里能够看到数据一致的视图。根据事务开始的时间不同，同时也意味着在同一个时刻不同事务看到的相同表里的数据可能是不同的。



#### 基本特征 

- 每行数据都存在一个版本，每次数据更新时都更新该版本。
- 修改时Copy出当前版本随意修改，各个事务之间无干扰。
- 保存时比较版本号，如果成功（commit）（CAS），则覆盖原记录；失败则放弃copy（rollback）



### InnoDB存储引擎MVCC的实现策略

在每一行数据中额外保存两个隐藏的列：当前行创建时的版本号和删除时的版本号 。



​							insert into testmvcc values(1,"test"); 

1.插入数据（insert）: create version 即当前事务的版本号 

![](D:\mdimage\微信截图_20200228153457.png)

2、在更新操作的时候，先标记旧的那行记录为已删除，并且delete version 是事务版本号，然后插入一行新的记录的方式。 

![](D:\mdimage\微信截图_20200228153657.png)



3、删除操作的时候，就把事务版本号作为删除版本号。 

![](D:\mdimage\微信截图_20200228153908.png)

4、查询操作：

从上面的描述可以看到，在查询时要符合以下两个条件的记录才能被事务查询出来：

create version <  事务version < delete version